name: debug machine
on:
  workflow_dispatch:
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
 #   - uses: ./  #./ 指的就是自己的储存库中，母目录的action.yml文件
  #    with:
  #      config-base64: ${{ secrets.CONFIG }}
#    - name: Setup upterm session
 #     uses: lhotari/action-upterm@v1

  setup-proxy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup mihomo
       # uses: ./.github/actions/setup-mihomo yaml在自己储存库可以这样写
        uses: ./ # Map9876/setup-v2ray@mm 这里的mm其实是GitHub action这些库的release的发布版本tags

        with:
          config-url: ${{ secrets.CONFIG_URL }} # clash yaml订阅链接
       #   config-base64: ${{ secrets.CONFIG_BASE64 }} # 你的 Base64 编码的 YAML 配置文件
          mihomo-version: "1.18.0" # 可选，默认是 1.18.0
      - name: cloudflared 
        run: |
          sleep 5
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -O cloudflared
          chmod +x cloudflared
          sudo mv cloudflared /usr/local/bin/
          cloudflared tunnel --url http://127.0.0.1:9090 2>&1 | tee cloudflared.log &
          sleep 10
          cat cloudflared.log | grep "trycloudflare"
    
      - name: Test proxy
        env:
          http_proxy: "http://127.0.0.1:7890"
          https_proxy: "http://127.0.0.1:7890"

        run: |
          
          #curl http://127.0.0.1:9090/ui/
          curl -X PUT http://127.0.0.1:9090/proxies/🔰%20选择节点 -d '{"name":"🇯🇵 免费-日本4-Ver.7"}'
          curl -x http://127.0.0.1:7890 https://api.live.bilibili.com/ip_service/v1/ip_service/get_ip_addr
          sleep 3000
