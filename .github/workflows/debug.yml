name: Debug Machine

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup mihomo
        uses: ./ # ä½¿ç”¨å½“å‰ä»“åº“ä¸­çš„ action
        with:
          config-url: ${{ secrets.CONFIG_URL }} # Clash YAML è®¢é˜…é“¾æ¥
          mihomo-version: "1.18.0" # å¯é€‰ï¼Œé»˜è®¤æ˜¯ 1.18.0

      - name: Install jq and bc
        run: |
          sudo apt-get update
          sudo apt-get install -y jq bc

      - name: Select fastest node
        run: |
          # è·å–æ‰€æœ‰èŠ‚ç‚¹ä¿¡æ¯
          response=$(curl -s http://127.0.0.1:9090/proxies/ğŸ”°%20é€‰æ‹©èŠ‚ç‚¹)
          echo "æ‰€æœ‰èŠ‚ç‚¹ä¿¡æ¯: $response"

          # æå–èŠ‚ç‚¹åç§°å¹¶è¿›è¡Œ URL ç¼–ç 
          nodes=$(echo "$response" | jq -r '.all[] | @uri')
          echo "å¯ç”¨èŠ‚ç‚¹: $nodes"

          # æµ‹è¯•æ¯ä¸ªèŠ‚ç‚¹çš„å»¶è¿Ÿ
          fastest_node=""
          min_delay=999999

          for node in $nodes; do
            echo "æµ‹è¯•èŠ‚ç‚¹: $node"
            delay=$(curl -o /dev/null -s -w "%{time_total}\n" -x http://127.0.0.1:7890 http://www.google.com --connect-timeout 2 --max-time 5)
            echo "èŠ‚ç‚¹ $node çš„å»¶è¿Ÿ: $delay ç§’"

            # æ¯”è¾ƒå»¶è¿Ÿï¼Œé€‰æ‹©æœ€å¿«çš„èŠ‚ç‚¹
            if (( $(echo "$delay < $min_delay" | bc -l) )); then
              min_delay=$delay
              fastest_node=$node
            fi
          done

          echo "æœ€å¿«èŠ‚ç‚¹: $fastest_node, å»¶è¿Ÿ: $min_delay ç§’"

          # é€‰æ‹©æœ€å¿«èŠ‚ç‚¹
          curl -X PUT http://127.0.0.1:9090/proxies/ğŸ”°%20é€‰æ‹©èŠ‚ç‚¹ -d "{\"name\":\"$(echo -n $fastest_node | jq -sRr @uri)\"}"
          echo "å·²é€‰æ‹©æœ€å¿«èŠ‚ç‚¹: $fastest_node"

      - name: Test proxy
        run: |
          curl -x http://127.0.0.1:7890 https://api.ip.sb/geoip
