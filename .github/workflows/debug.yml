name: Debug Machine

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # ========== åŸæœ‰é…ç½®ï¼ˆå®Œå…¨ä¿ç•™ï¼‰==========
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Mihomo
        uses: ./
        with:
          config-url: ${{ secrets.CONFIG_URL }}
          mihomo-version: "1.18.0"

      # ========== ä»¥ä¸‹ä¸ºåŸæœ‰é…ç½®ï¼ˆå®Œå…¨ä¸å˜ï¼‰==========
      - name: Install jq and bc
        run: |
          sudo apt-get update
          sudo apt-get install -y jq bc

      - name: Select fastest node
        run: |
          response=$(curl -s http://127.0.0.1:9090/proxies/ğŸ”°%20é€‰æ‹©èŠ‚ç‚¹)
          nodes=$(echo "$response" | jq -r '.all[] | @uri')
          fastest_node=""
          min_delay=999999
          for node in $nodes; do
            [ "$node" == "DIRECT" ] && continue
            delay=$(curl -o /dev/null -s -w "%{time_total}\n" -x http://127.0.0.1:7890 http://1.1.1.1)
            (( $(echo "$delay < $min_delay" | bc -l) )) && min_delay=$delay && fastest_node=$node
          done
          curl -X PUT http://127.0.0.1:9090/proxies/ğŸ”°%20é€‰æ‹©èŠ‚ç‚¹ -d "{\"name\":\"$(echo -n $fastest_node | jq -sRr @uri)\"}"

      - name: Test proxy
        run: curl -x http://127.0.0.1:7890 https://api.ip.sb/geoip

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            apt-transport-https \
            ca-certificates \
            curl \
            gnupg \
            lsb-release

      - name: Install VNC and Desktop
        run: |
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            xfce4 \
            xfce4-goodies \
            tightvncserver \
            novnc \
            firefox \
            xclip
            
      - name: Configure proxy env
        run: |
          echo 'function proxy_on() {
            export http_proxy=http://127.0.0.1:7890
            export https_proxy=http://127.0.0.1:7890
            export all_proxy=socks5://127.0.0.1:7890
            echo -e "ç»ˆç«¯ä»£ç†å·²å¼€å¯"
          }
          function proxy_off(){
            unset http_proxy https_proxy all_proxy
            echo -e "ç»ˆç«¯ä»£ç†å·²å…³é—­"
          }' > ~/.bash_profile
          source ~/.bash_profile
          proxy_on

      # ========== æ–°å¢å‰ªè´´æ¿é…ç½®ï¼ˆä¿æŒå¯†ç ä¸å˜ï¼‰==========
      - name: Enhance VNC Clipboard
        run: |
          # å®‰è£…å‰ªè´´æ¿æ”¯æŒç»„ä»¶
          sudo apt-get install -y xclip xsel

          # é…ç½®VNCå‰ªè´´æ¿ï¼ˆä¸ä¿®æ”¹å¯†ç ï¼‰
          mkdir -p ~/.vnc
          echo -e "SendPrimary=1\nAcceptCutText=1\nSendCutText=1" > ~/.vnc/config
          
          
          
          echo '#!/bin/bash
          # åŠ è½½ä»£ç†ç¯å¢ƒå˜é‡
          source ~/.bash_profile
          export http_proxy=http://127.0.0.1:7890
          export https_proxy=http://127.0.0.1:7890
          export all_proxy=socks5://127.0.0.1:7890
          export DISPLAY=:1

          # å¯åŠ¨æ¡Œé¢ç¯å¢ƒ
          startxfce4 &
          xhost +
          vncconfig -nowin -set SendPrimary=1 -set AcceptCutText=1 -set SendCutText=1 &
          export MOZ_ENABLE_WAYLAND=0
          export GDK_BACKEND=x11
          firefox &
          ' > ~/.vnc/xstartup
          chmod +x ~/.vnc/xstartup

      # ========== åŸæœ‰æœåŠ¡é…ç½®ï¼ˆä»…å¢å¼ºå‚æ•°ï¼‰==========
      - name: Start VNC Server
        run: |
          vncserver :1 -geometry 1280x800 -depth 24 \
            -SendCutText=1 \      # æ–°å¢å‚æ•°
            -AcceptCutText=1 \    # æ–°å¢å‚æ•°
            -Clipboard=1          # æ–°å¢å‚æ•°
          sleep 5
          
      - name: Configure noVNC
        run: |
          git clone https://github.com/novnc/noVNC.git
          cd noVNC
          ./utils/novnc_proxy --vnc localhost:5901 & # ä¸¥æ ¼ä¿ç•™åŸå§‹æ³¨é‡Š
          echo "noVNCæœåŠ¡å·²å¯åŠ¨ï¼š6080ç«¯å£"
          
      # ========== æ–°å¢å‰ªè´´æ¿éªŒè¯æ­¥éª¤ ==========
      - name: Verify Clipboard
        run: |
          # å†™å…¥æµ‹è¯•å†…å®¹åˆ°æœåŠ¡å™¨å‰ªè´´æ¿
          echo "VNC_CLIPBOARD_TEST" | xclip -selection clipboard
          
          # ä»å®¢æˆ·ç«¯è¯»å–éªŒè¯ï¼ˆæ¨¡æ‹Ÿï¼‰
          echo "è¯·æ‰‹åŠ¨éªŒè¯å®¢æˆ·ç«¯å‰ªè´´æ¿æ˜¯å¦åŒ…å«: VNC_CLIPBOARD_TEST"
          
          # ä¿æŒæœåŠ¡è¿è¡Œï¼ˆåŸæœ‰é…ç½®ï¼‰ 
          while true; do
            echo "[$(date)] æœåŠ¡è¿è¡Œä¸­..."
            sleep 300
          done



      - name: Configure Cloudflared
        run: |
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared-linux-amd64.deb

      - name: Start Cloudflared tunnels
        run: |
          cloudflared tunnel --url tcp://localhost:5901 --protocol http2 &
          cloudflared tunnel --url http://localhost:9090 &
          cloudflared tunnel --url http://localhost:6080 &
          sleep 1
