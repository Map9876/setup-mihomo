name: debug machine
on:
  workflow_dispatch:
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
 #   - uses: ./  #./ æŒ‡çš„å°±æ˜¯è‡ªå·±çš„å‚¨å­˜åº“ä¸­ï¼Œæ¯ç›®å½•çš„action.ymlæ–‡ä»¶
  #    with:
  #      config-base64: ${{ secrets.CONFIG }}
#    - name: Setup upterm session
 #     uses: lhotari/action-upterm@v1

  setup-proxy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup mihomo
       # uses: ./.github/actions/setup-mihomo yamlåœ¨è‡ªå·±å‚¨å­˜åº“å¯ä»¥è¿™æ ·å†™
        uses: ./ # Map9876/setup-v2ray@mm è¿™é‡Œçš„mmå…¶å®žæ˜¯GitHub actionè¿™äº›åº“çš„releaseçš„å‘å¸ƒç‰ˆæœ¬tags

        with:
          config-url: ${{ secrets.CONFIG_URL }} # clash yamlè®¢é˜…é“¾æŽ¥
       #   config-base64: ${{ secrets.CONFIG_BASE64 }} # ä½ çš„ Base64 ç¼–ç çš„ YAML é…ç½®æ–‡ä»¶
          mihomo-version: "1.18.0" # å¯é€‰ï¼Œé»˜è®¤æ˜¯ 1.18.0
          
          
      - name: start proxy
        run: |         
          curl -X PUT http://127.0.0.1:9090/proxies/ðŸ”°%20é€‰æ‹©èŠ‚ç‚¹ -d '{"name":"ðŸ‡¯ðŸ‡µ å…è´¹-æ—¥æœ¬4-Ver.7"}'
          
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y tigervnc-standalone-server firefox xterm
      # 3. é…ç½®VNC
      - name: Configure VNC
        run: |
          mkdir -p ~/.vnc
          echo "#!/bin/sh" > ~/.vnc/xstartup
          echo "tigervncserver -xstartup /usr/bin/xterm" >> ~/.vnc/xstartup  # å¯åŠ¨xterm
          echo "firefox &" >> ~/.vnc/xstartup  # å¯åŠ¨firefox
          chmod +x ~/.vnc/xstartup
      # 4. è®¾ç½®VNCå¯†ç 
      - name: Set VNC password
        run: |
          echo "password" | vncpasswd -f > ~/.vnc/passwd
          chmod 600 ~/.vnc/passwd
      # 5. å¯åŠ¨VNCæœåŠ¡å™¨
      - name: Start VNC server
        run: |         
          vncserver :1 -geometry 1280x1024 -depth 24
          
                    
                                        
          
      - name: cloudflared 
        run: |
          sleep 10
          export https_proxy=http://127.0.0.1:7890 http_proxy=http://127.0.0.1:7890
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -O cloudflared
          chmod +x cloudflared
          sudo mv cloudflared /usr/local/bin/
          cloudflared tunnel --url http://127.0.0.1:6080 2>&1 | tee cloudflared.log &
          sleep 10
          cat cloudflared.log | grep "trycloudflare"
    
      - name: Test proxy
        env:
          http_proxy: "http://127.0.0.1:7890"
          https_proxy: "http://127.0.0.1:7890"
        run: |         
          #curl http://127.0.0.1:9090/ui/
          curl -x http://127.0.0.1:7890 https://api.live.bilibili.com/ip_service/v1/ip_service/get_ip_addr
          sleep 3000
