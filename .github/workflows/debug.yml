name: Debug Machine

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup mihomo
        uses: ./ # ä½¿ç”¨å½“å‰ä»“åº“ä¸­çš„ action
        with:
          config-url: ${{ secrets.CONFIG_URL }} # Clash YAML è®¢é˜…é“¾æ¥
          mihomo-version: "1.18.0" # å¯é€‰ï¼Œé»˜è®¤æ˜¯ 1.18.0

      - name: Start proxy
        run: |
          curl -X PUT http://127.0.0.1:9090/proxies/ğŸ”°%20é€‰æ‹©èŠ‚ç‚¹ -d '{"name":"ğŸ‡¯ğŸ‡µ å…è´¹-æ—¥æœ¬4-Ver.7"}'

      - name: Set global proxy environment variables
        run: |
          echo "http_proxy=http://127.0.0.1:7890" >> $GITHUB_ENV
          echo "https_proxy=http://127.0.0.1:7890" >> $GITHUB_ENV
          echo "HTTP_PROXY=http://127.0.0.1:7890" >> $GITHUB_ENV
          echo "HTTPS_PROXY=http://127.0.0.1:7890" >> $GITHUB_ENV
          echo 'export http_proxy=http://127.0.0.1:7890' >> ~/.bashrc
          echo 'export https_proxy=http://127.0.0.1:7890' >> ~/.bashrc
          echo 'export HTTP_PROXY=http://127.0.0.1:7890' >> ~/.bashrc
          echo 'export HTTPS_PROXY=http://127.0.0.1:7890' >> ~/.bashrc
          source ~/.bashrc
          

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            apt-transport-https \
            ca-certificates \
            curl \
            gnupg \
            lsb-release

      - name: Install Docker using official script
        run: |
          curl -fsSL https://get.docker.com -o get-docker.sh
          sh get-docker.sh

      - name: Create Firefox User-Agent config
        run: |
          mkdir -p ~/firefox-config
          echo 'user_pref("general.useragent.override", "Mozilla/5.0 (iPhone; CPU iPhone OS 14_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/14.0 Mobile/15E148 Safari/604.1");' > ~/firefox-config/prefs.js

      - name: Run Firefox in Docker
        run: |
          docker run -d --name firefox \
            -e TZ=Asia/Hong_Kong \
            -e DISPLAY_WIDTH=1080 \
            -e DISPLAY_HEIGHT=1920 \
            -e KEEP_APP_RUNNING=1 \
            -e ENABLE_CJK_FONT=1 \
            -e VNC_PASSWORD=admin \
            -p 5800:5800 -p 5900:5900 \
            -v ~/firefox-config:/config/firefox:rw \
            --shm-size 2g \
            jlesage/firefox

      - name: Install Cloudflared
        run: |
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared-linux-amd64.deb

      - name: Start Cloudflared
        run: |
          # è½¬å‘ noVNC ç«¯å£ 5800
          cloudflared tunnel --url http://localhost:5800 &          
          # è·å–å¹¶æ˜¾ç¤ºéš§é“URL
          echo "ç­‰å¾…Cloudflaredéš§é“URL..."
          sleep 10
          ps aux | grep cloudflared

      - name: Keep Alive and Monitor
        run: |
          echo "=== Firefox VNC Server Information ==="
          echo "noVNCç«¯å£: 5800"
          echo "VNCç«¯å£: 5900"
          echo "VNCå¯†ç : admin"
          echo "è¯´æ˜: ä½¿ç”¨æµè§ˆå™¨è¿æ¥æ—¶ï¼Œä¸»æœºåœ°å€ä½¿ç”¨ä¸Šé¢cloudflaredç”Ÿæˆçš„åŸŸå"
          echo "ç«¯å£ä½¿ç”¨: å¤åˆ¶cloudflared URLåçš„ç«¯å£å·"
          
          while true; do
            echo "=== Status Update $(date) ==="
            docker ps
            sleep 300
          done
