name: Debug Machine

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup mihomo
        uses: ./ # 使用当前仓库中的 action
        with:
          config-url: ${{ secrets.CONFIG_URL }} # Clash YAML 订阅链接
          mihomo-version: "1.18.0" # 可选，默认是 1.18.0

      - name: Start proxy
        run: |
          curl -X PUT http://127.0.0.1:9090/proxies/🔰%20选择节点 -d '{"name":"🇯🇵 免费-日本4-Ver.7"}'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y tigervnc-standalone-server firefox xterm novnc

      - name: Configure VNC
        run: |
          mkdir -p ~/.vnc
          echo "#!/bin/sh" > ~/.vnc/xstartup
          echo "tigervncserver -xstartup /usr/bin/xterm" >> ~/.vnc/xstartup  # 启动 xterm
          echo "firefox &" >> ~/.vnc/xstartup  # 启动 firefox
          chmod +x ~/.vnc/xstartup

      - name: Set VNC password
        run: |
          echo "password" | vncpasswd -f > ~/.vnc/passwd
          chmod 600 ~/.vnc/passwd

      - name: Start VNC server
        run: |
          vncserver :1 -geometry 1280x1024 -depth 24

      - name: Start noVNC
        run: |
          /usr/bin/websockify --web /usr/share/novnc 6080 localhost:5901 &
          echo "noVNC 已启动，端口为 6080"

      - name: Setup Cloudflared
        run: |
          sleep 5
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -O cloudflared
          chmod +x cloudflared
          sudo mv cloudflared /usr/local/bin/
          export https_proxy=http://127.0.0.1:7890 http_proxy=http://127.0.0.1:7890
          cloudflared tunnel --url http://127.0.0.1:6080 2>&1 | tee cloudflared.log &
          sleep 10
          cat cloudflared.log | grep "trycloudflare"

      - name: Test proxy
        env:
          http_proxy: "http://127.0.0.1:7890"
          https_proxy: "http://127.0.0.1:7890"
        run: |
          curl -x http://127.0.0.1:7890 https://api.live.bilibili.com/ip_service/v1/ip_service/get_ip_addr
          sleep 3000
