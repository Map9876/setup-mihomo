name: Debug Machine

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup mihomo
        uses: ./ # ä½¿ç”¨å½“å‰ä»“åº“ä¸­çš„ action
        with:
          config-url: ${{ secrets.CONFIG_URL }} # Clash YAML è®¢é˜…é“¾æ¥
          mihomo-version: "1.18.0" # å¯é€‰ï¼Œé»˜è®¤æ˜¯ 1.18.0

      - name: Create and configure ~/.bash_profile
        run: |
          echo 'function proxy_on() {
            export http_proxy=http://127.0.0.1:7890
            export https_proxy=http://127.0.0.1:7890
            export all_proxy=socks5://127.0.0.1:7890
            echo -e "ç»ˆç«¯ä»£ç†å·²å¼€å¯"
          }

          function proxy_off(){
            unset http_proxy https_proxy all_proxy
            echo -e "ç»ˆç«¯ä»£ç†å·²å…³é—­"
          }' > ~/.bash_profile

          source ~/.bash_profile
          proxy_on

      - name: Install jq and bc
        run: |
          sudo apt-get update
          sudo apt-get install -y jq bc

      - name: Select fastest node
        run: |
          # è·å–æ‰€æœ‰èŠ‚ç‚¹ä¿¡æ¯
          response=$(curl -s http://127.0.0.1:9090/proxies/ğŸ”°%20é€‰æ‹©èŠ‚ç‚¹)
          echo "æ‰€æœ‰èŠ‚ç‚¹ä¿¡æ¯: $response"

          # æå–èŠ‚ç‚¹åç§°å¹¶è¿›è¡Œ URL ç¼–ç 
          nodes=$(echo "$response" | jq -r '.all[] | @uri')
          echo "å¯ç”¨èŠ‚ç‚¹: $nodes"

          # æµ‹è¯•æ¯ä¸ªèŠ‚ç‚¹çš„å»¶è¿Ÿ
          fastest_node=""
          min_delay=999999

          for node in $nodes; do
            # è·³è¿‡ DIRECT èŠ‚ç‚¹
            if [ "$node" == "DIRECT" ]; then
              echo "è·³è¿‡ DIRECT èŠ‚ç‚¹"
              continue
            fi

            echo "æµ‹è¯•èŠ‚ç‚¹: $node"
            delay=$(curl -o /dev/null -s -w "%{time_total}\n" -x http://127.0.0.1:7890 http://1.1.1.1 --connect-timeout 10 --max-time 10)
            if [ $? -ne 0 ]; then
              echo "èŠ‚ç‚¹ $node ä¸å¯ç”¨ï¼Œè·³è¿‡"
              continue
            fi
            echo "èŠ‚ç‚¹ $node çš„å»¶è¿Ÿ: $delay ç§’"

            # æ¯”è¾ƒå»¶è¿Ÿï¼Œé€‰æ‹©æœ€å¿«çš„èŠ‚ç‚¹
            if (( $(echo "$delay < $min_delay" | bc -l) )); then
              min_delay=$delay
              fastest_node=$node
            fi
          done

          echo "æœ€å¿«èŠ‚ç‚¹: $fastest_node, å»¶è¿Ÿ: $min_delay ç§’"

          # é€‰æ‹©æœ€å¿«èŠ‚ç‚¹
          curl -X PUT http://127.0.0.1:9090/proxies/ğŸ”°%20é€‰æ‹©èŠ‚ç‚¹ -d "{\"name\":\"$(echo -n $fastest_node | jq -sRr @uri)\"}"
          echo "å·²é€‰æ‹©æœ€å¿«èŠ‚ç‚¹: $fastest_node"

      - name: Test proxy
        run: |
          curl -x http://127.0.0.1:7890 https://api.ip.sb/geoip

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            apt-transport-https \
            ca-certificates \
            curl \
            gnupg \
            lsb-release

      - name: Install VNC and Desktop Environment
        run: |
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            xfce4 \
            xfce4-goodies \
            tightvncserver \
            novnc \
            python3 \
            python3-pip \
            git \
            firefox \
            xterm

      - name: Configure VNC
        run: |
          mkdir -p ~/.vnc
          mkdir .secret -p
          mkdir -p ~/.secret
          mkdir -p /home/runner/.secret
          ls -la ~/.secret  # æ£€æŸ¥ç›®å½•æ˜¯å¦åˆ›å»ºæˆåŠŸ
          chmod 755 ~  # ç¡®ä¿ä¸»ç›®å½•æœ‰æ‰§è¡Œæƒé™
          chmod 755 ~/.secret  # ç¡®ä¿ .secret ç›®å½•æœ‰å†™æƒé™
          echo "password" | vncpasswd -f > ~/.secret/passvnc
          echo "password" | vncpasswd -f > ~/.vnc/passwd
          #è¿™é‡Œæ˜¯è¯´æŠŠpasswordä½œä¸ºå¯†ç ï¼Œä½¿ç”¨vncpasswdè¿™ä¸ªå‘½ä»¤è¡Œç¨‹åºï¼Œå†™å…¥åˆ°passwdè¿™ä¸ªæ–‡æœ¬æ–‡ä»¶é‡Œé¢ï¼Œå¦‚æœæ‰“å¼€passwdï¼Œå¯ä»¥çœ‹åˆ°å®ƒæ˜¯ä¹±ç ï¼Œæ‰€ä»¥å¹¶ä¸èƒ½ç›´æ¥ä»¥txtæ‰“å¼€å®ƒpasswdæ–‡ä»¶ï¼Œç„¶åæŠŠpasswordå¤åˆ¶ç²˜è´´è¿›å»
          chmod 600 ~/.vnc/passwd
          chmod 600 ~/.secret/passvnc
          echo '#!/bin/bash
          # åŠ è½½ä»£ç†ç¯å¢ƒå˜é‡
          source ~/.bash_profile
          export http_proxy=http://127.0.0.1:7890
          export https_proxy=http://127.0.0.1:7890
          export all_proxy=socks5://127.0.0.1:7890

          xterm &
          firefox &' > ~/.vnc/xstartup
          chmod +x ~/.vnc/xstartup

      - name: Start VNC Server
        run: |
          vncserver :1 -geometry 1280x800 -depth 24
          sleep 5  # Wait for VNC server to start properly

      - name: Install and Setup noVNC
        run: |
          git clone https://github.com/novnc/noVNC.git
          cd noVNC
          ./utils/novnc_proxy --vnc localhost:5901 & #novnc webç«¯å£6080

      - name: Install Cloudflared
        run: |
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared-linux-amd64.deb
      - name: Start Cloudflared for vnc
        run: |
          # æš´éœ² Mihomo Web UI ç«¯å£ 9090
          cloudflared tunnel --url tcp://localhost:5901 --protocol http2 &
          echo "ç­‰å¾… Mihomo Web UI çš„ Cloudflared éš§é“URL..."
          sleep 10
          ps aux | grep cloudflared


      - name: Start Cloudflared for Mihomo Web UI
        run: |
          # æš´éœ² Mihomo Web UI ç«¯å£ 9090
          cloudflared tunnel --url http://localhost:9090 &
          echo "ç­‰å¾… Mihomo Web UI çš„ Cloudflared éš§é“URL..."
          sleep 10
          ps aux | grep cloudflared

      - name: Start Cloudflared for noVNC
        run: |
          # æš´éœ² noVNC ç«¯å£ 6080
          cloudflared tunnel --url http://localhost:6080 --protocol http2 &
          echo "ç­‰å¾… noVNC çš„ Cloudflared éš§é“URL..."
          sleep 10
          ps aux | grep cloudflared

      - name: Keep Alive and Monitor
        run: |
          echo "=== Firefox VNC Server Information ==="
          echo "noVNCç«¯å£: 6080"
          echo "VNCç«¯å£: 5901"
          echo "VNCå¯†ç : password"
          echo "è¯´æ˜: ä½¿ç”¨æµè§ˆå™¨è¿æ¥æ—¶ï¼Œä¸»æœºåœ°å€ä½¿ç”¨ä¸Šé¢cloudflaredç”Ÿæˆçš„åŸŸå"
          echo "ç«¯å£ä½¿ç”¨: å¤åˆ¶cloudflared URLåçš„ç«¯å£å·"

          echo "=== Mihomo Web UI Information ==="
          echo "Web UIç«¯å£: 9090"
          echo "è¯´æ˜: ä½¿ç”¨æµè§ˆå™¨è¿æ¥æ—¶ï¼Œä¸»æœºåœ°å€ä½¿ç”¨ä¸Šé¢cloudflaredç”Ÿæˆçš„åŸŸå"
          echo "ç«¯å£ä½¿ç”¨: å¤åˆ¶cloudflared URLåçš„ç«¯å£å·"

          while true; do
            echo "=== Status Update $(date) ==="
            docker ps
            sleep 300
          done
